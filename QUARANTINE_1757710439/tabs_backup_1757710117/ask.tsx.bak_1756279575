import React, { useState } from 'react'
import { SafeAreaView, View, Text, TextInput, TouchableOpacity, KeyboardAvoidingView, StyleSheet, ActivityIndicator } from 'react-native'
import DonateFAB from '../components/DonateFAB'

export default function Ask(){
  const [question,setQuestion]=useState('')
  const [answer,setAnswer]=useState('')
  const [loading,setLoading]=useState(false)

  async function handleAsk(){
    if(!question.trim()) return
    setLoading(true)
    setAnswer('')
    try{
      const res=await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':`Bearer ${process.env.EXPO_PUBLIC_OPENAI_KEY}`
        },
        body:JSON.stringify({
          model:'gpt-4o-mini',
          messages:[{role:'system',content:'Answer sassily with sources OpenAI + Wikipedia'}, {role:'user',content:question}]
        })
      })
      const data=await res.json()
      const txt=data.choices?.[0]?.message?.content||'No answer'
      setAnswer(txt+"\n\nSources: OpenAI, Wikipedia")
    }catch(e){ setAnswer('Error: '+e.message) }
    setLoading(false)
  }

  return(
    <SafeAreaView style={s.wrap}>
      <KeyboardAvoidingView style={s.wrap} behavior="padding">
        <View style={s.container}>
          <TextInput
            style={s.input}
            placeholder="Ask Nova anything..."
            placeholderTextColor="#555"
            value={question}
            onChangeText={setQuestion}
          />
          <TouchableOpacity onPress={handleAsk} style={s.btn}>
            <Text style={s.btnTxt}>Ask</Text>
          </TouchableOpacity>
        </View>

        {loading && <Text style={s.think}>Nova is thinking...</Text>}
        {loading && <ActivityIndicator size="large" color="#0ff"/>}

        {!!answer && (
          <View style={s.answerBox}>
            <Text style={s.answer}>{answer}</Text>
          </View>
        )}

        <DonateFAB/>
      </KeyboardAvoidingView>
    </SafeAreaView>
  )
}

const s=StyleSheet.create({
  wrap:{flex:1,backgroundColor:'#000'},
  container:{flexDirection:'row',padding:12,alignItems:'center'},
  input:{flex:1,backgroundColor:'#111',color:'#fff',padding:10,borderRadius:10,borderWidth:1,borderColor:'#0ff'},
  btn:{marginLeft:10,backgroundColor:'#0ff',paddingHorizontal:16,paddingVertical:10,borderRadius:10},
  btnTxt:{color:'#000',fontWeight:'900'},
  think:{color:'#0ff',textAlign:'center',marginTop:10,fontStyle:'italic'},
  answerBox:{marginTop:20,padding:14,backgroundColor:'#0b1220',borderRadius:12,borderWidth:1,borderColor:'#0ff'},
  answer:{color:'#fff'}
})
