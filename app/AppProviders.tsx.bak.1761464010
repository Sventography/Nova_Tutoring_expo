import React, { useEffect } from "react";
import * as Linking from "expo-linking";
import { useTheme } from "./context/ThemeContext";

import { ThemeProvider } from "./context/ThemeContext";
import { CoinsProvider, useCoins } from "./context/CoinsContext";
import { PurchasesProvider, usePurchases } from "./context/PurchasesContext";
import { CursorProvider, useCursor } from "./context/CursorContext";
import { CollectionsProvider } from "./context/CollectionsContext";
import { StreakProvider } from "./context/StreakContext";
import { AchievementsProvider } from "./context/AchievementsContext";
import { ToastProvider } from "./context/ToastContext";
import { CertificatesProvider } from "./context/CertificatesContext";
import { UserProvider } from "./context/UserContext";


function DevThemeListener() {
  const { setThemeById } = useTheme();
  React.useEffect(() => {
    const handle = (url?: string | null) => {
      if (!url) return;
      const { hostname, path, queryParams } = Linking.parse(url);
      const route = (hostname || path || "").toLowerCase();
      // Accept: novatutoring://theme?id=theme:starry
      if (route.includes("theme") && queryParams && typeof queryParams.id !== "undefined") {
        const id = String(queryParams.id);
        if (id) setThemeById(id as any);
      }
    };
    Linking.getInitialURL().then(handle).catch(() => {});
    const sub = Linking.addEventListener("url", (e) => handle(e.url));
    return () => sub.remove();
  }, [setThemeById]);
  return null;
}
function DevCoinsListener() {
  const { addCoins } = useCoins();
  useEffect(() => {
    const handle = (url?: string | null) => {
      if (!url) return;
      const { hostname, path, queryParams } = Linking.parse(url);
      const route = (hostname || path || "").toLowerCase();
      if (route.includes("coins") && queryParams && typeof queryParams.add !== "undefined") {
        const amt = Number(queryParams.add);
        if (!Number.isNaN(amt) && amt !== 0) addCoins(amt);
      }
    };
    Linking.getInitialURL().then(handle).catch(() => {});
    const sub = Linking.addEventListener("url", (e) => handle(e.url));
    return () => sub.remove();
  }, [addCoins]);
  return null;
}


function DevGrantListener() {
  const { grant } = usePurchases();
  const { setCursorById } = useCursor();
  React.useEffect(() => {
    const handle = (url) => {
      if (!url) return;
      const { hostname, path, queryParams } = Linking.parse(url);
      const route = (hostname || path || "").toLowerCase();

      if (route.includes("grant") && queryParams && queryParams.id) {
        const raw = String(queryParams.id);
        let ids = raw.split(",").map(s => s.trim()).filter(Boolean);
        if (ids.length === 1 && ids[0] === "all") {
          ids = [
            "theme:neon","theme:starry","theme:pink","theme:dark","theme:mint",
            "theme:glitter","theme:blackgold","theme:crimson","theme:emerald",
            "theme:neonpurple","theme:silver","cursor:glow","cursor:orb","cursor:star-trail"
          ];
        }
        ids.forEach(id => id.startsWith("cursor:") && setCursorById(id));
        grant(ids).catch(()=>{});
      }
    };
    Linking.getInitialURL().then(handle).catch(()=>{});
    const sub = Linking.addEventListener("url", e => handle(e.url));
    return () => sub.remove();
  }, [grant, setCursorById]);
  return null;
}

export function AppProviders(props: any) {
  const { children } = props;
  return (
    <StreakProvider>
      <AchievementsProvider>
        <ToastProvider>
          <CertificatesProvider>
            <CoinsProvider>
              <PurchasesProvider>
                <ThemeProvider>
                  <CursorProvider>
                    <CollectionsProvider>
                      <UserProvider>
                        <DevCoinsListener />
                        <DevGrantListener />
                        <DevThemeListener />
                        {children}
                      </UserProvider>
                    </CollectionsProvider>
                  </CursorProvider>
                </ThemeProvider>
              </PurchasesProvider>
            </CoinsProvider>
          </CertificatesProvider>
        </ToastProvider>
      </AchievementsProvider>
    </StreakProvider>
  );
}

export default AppProviders;
