import os
from flask import Flask, request, jsonify
from flask_cors import CORS

# Optional Stripe (card flow). Coins flow will work without it.
try:
    import stripe
except Exception:
    stripe = None

app = Flask(__name__)
CORS(app, resources={r"/*": {"origins": "*"}})

# Load server/.env if present
try:
    from dotenv import load_dotenv
    load_dotenv(os.path.join(os.path.dirname(__file__), ".env"))
except Exception:
    pass

STRIPE_SECRET_KEY = os.getenv("STRIPE_SECRET_KEY", "").strip()
if stripe and STRIPE_SECRET_KEY:
    stripe.api_key = STRIPE_SECRET_KEY
    print("[server] Stripe secret loaded:", True)
else:
    print("[server] Stripe secret loaded:", False)

# Simple SKU price map (USD cents)
SKU_PRICES = {
    "SKU_PLUSHIE_PJS": 6000 * 100,
    "SKU_TEE_GLOW":    8000 * 100,
    "SKU_HOODIE":     12000 * 100,
}

@app.get("/health")
def health():
    return jsonify(ok=True, service="nova-backend", status="up")

@app.post("/checkout/start")
def checkout_start():
    body = request.get_json(silent=True) or {}
    sku = body.get("sku")
    method = (body.get("method") or "").lower()  # "coins" or "card"
    quantity = int(body.get("quantity") or 1)

    if not sku:
        return jsonify(ok=False, error="missing sku"), 400
    if quantity < 1:
        return jsonify(ok=False, error="invalid quantity"), 400

    # COINS path (no Stripe required)
    if method == "coins":
        # TODO: replace with real coin deduction + order persist
        return jsonify(ok=True, mode="coins", sku=sku, quantity=quantity,
                       message="coins checkout confirmed (mock)")

    # CARD path (Stripe)
    if method == "card":
        if not (stripe and STRIPE_SECRET_KEY):
            return jsonify(ok=False, error="stripe not configured"), 500

        amount = SKU_PRICES.get(sku)
        if not amount:
            return jsonify(ok=False, error=f"unknown sku: {sku}"), 400

        try:
            intent = stripe.PaymentIntent.create(
                amount=amount * quantity,
                currency="usd",
                automatic_payment_methods={"enabled": True},
                metadata={"sku": sku, "quantity": quantity},
            )
            return jsonify(ok=True, mode="card", clientSecret=intent.client_secret)
        except Exception as e:
            return jsonify(ok=False, error=str(e)), 500

    return jsonify(ok=False, error="unsupported method; use 'coins' or 'card'"), 400

# Debug route list so we can verify whatâ€™s exposed
@app.get("/__routes")
def __routes():
    return {
        "routes": sorted([{
            "rule": str(r.rule),
            "endpoint": r.endpoint,
            "methods": sorted(list(r.methods - {"HEAD","OPTIONS"}))
        } for r in app.url_map.iter_rules()], key=lambda x: x["rule"])
    }

if __name__ == "__main__":
    port = int(os.getenv("PORT", "8787"))
    print(f"[server] starting on http://127.0.0.1:{port}")
    app.run(host="0.0.0.0", port=port, debug=False)
